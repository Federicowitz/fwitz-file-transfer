<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federicowitz Share</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text-main: #1f2937;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        .container { max-width: 500px; margin: 20px auto; padding: 0 20px; flex: 1; }
        
        h1 { text-align: center; margin-bottom: 20px; font-size: 1.4rem; display: flex; justify-content: center; gap: 8px; }

        /* CARD GENERICHE */
        .card {
            background: var(--card); border-radius: 16px; padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px;
        }

        /* --- HOST PANEL (Chi crea il QR) --- */
        #host-panel { display: block; } /* Visibile di default */

        .settings-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #eef2ff; padding: 10px; border-radius: 10px; margin-bottom: 15px;
        }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        #qr-canvas { border: 6px solid white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 100%; }
        .link-text { font-size: 0.8rem; color: var(--primary); margin-top: 10px; word-break: break-all; cursor: pointer; }

        /* --- GUEST LOADING (Chi scansiona) --- */
        #guest-loading { display: none; text-align: center; padding: 40px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- TRANSFER AREA (Comune) --- */
        #transfer-area { display: none; }

        .upload-btn {
            display: flex; flex-direction: column; align-items: center;
            border: 2px dashed var(--primary); background: #eff6ff; color: var(--primary);
            padding: 25px; border-radius: 12px; cursor: pointer; font-weight: 600;
        }
        input[type="file"] { display: none; }

        .progress-box { margin-top: 15px; display: none; }
        .progress-bar { width: 100%; background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s; }
        
        .file-item {
            background: #f9fafb; padding: 12px; border-radius: 8px; border-left: 4px solid var(--success);
            margin-top: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .btn-dl { background: var(--success); color: white; text-decoration: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; }

        footer { text-align: center; padding: 20px; font-size: 0.8rem; color: #6b7280; margin-top: auto; }
        footer a { color: #6b7280; text-decoration: none; }
    </style>
</head>
<body>

<div class="container">
    <h1><span id="shield-icon">üõ°Ô∏è</span> Federicowitz Share</h1>

    <!-- PANNELLO HOST (PC che mostra QR) -->
    <div id="host-panel" class="card">
        <div class="settings-bar">
            <div>
                <div style="font-weight:600; font-size:0.9rem">Modalit√† Bunker</div>
                <div style="font-size:0.75rem; color:#666">Solo LAN (Sicuro)</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="modeSwitch" checked>
                <span class="slider"></span>
            </label>
        </div>

        <div style="text-align:center">
            <div id="qr-loading">Generazione QR...</div>
            <canvas id="qr-canvas" style="display:none"></canvas>
            <p style="font-size:0.85rem; color:#666">Scansiona per connetterti</p>
            <div id="link-text" class="link-text" onclick="copyLink()">Copia Link</div>
        </div>
    </div>

    <!-- PANNELLO OSPITE (Telefono che carica) -->
    <div id="guest-loading" class="card">
        <div class="spinner"></div>
        <h3>Connessione in corso...</h3>
        <p style="font-size:0.9rem; color:#666">Resta in questa pagina.</p>
    </div>

    <!-- PANNELLO TRASFERIMENTO (Attivo dopo connessione) -->
    <div id="transfer-area">
        <!-- Invio -->
        <div class="card">
            <h3>üì§ Invia File</h3>
            <label class="upload-btn">
                <span>Tocca per selezionare</span>
                <input type="file" id="fileInput">
            </label>
            <div id="send-progress" class="progress-box">
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px">
                    <span>Invio...</span><span id="send-percent">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="send-fill"></div></div>
            </div>
        </div>

        <!-- Ricezione -->
        <div class="card">
            <h3>üì• Ricevuti</h3>
            <div id="rec-progress" class="progress-box">
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px">
                    <span id="rec-name">Ricezione...</span><span id="rec-percent">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="rec-fill"></div></div>
            </div>
            <div id="file-list"></div>
            <div id="empty-msg" style="text-align:center; color:#ccc; font-size:0.9rem">Nessun file ricevuto</div>
        </div>
    </div>
</div>

<footer>
    <p>Made by <strong>Federicowitz</strong></p>
    <p><a href="#">Website</a> ‚Ä¢ <a href="#">Instagram</a></p>
</footer>

<script>
    // --- VARIABILI ---
    let peer, conn, myId;
    const modeSwitch = document.getElementById('modeSwitch');
    const shieldIcon = document.getElementById('shield-icon');
    
    // Controlliamo SUBITO se siamo ospiti
    const urlParams = new URLSearchParams(window.location.search);
    const targetId = urlParams.get('connectTo');

    // --- SETUP INTERFACCIA INIZIALE ---
    if (targetId) {
        // OSPITE: Nascondi tutto il pannello Host IMMEDIATAMENTE
        document.getElementById('host-panel').style.display = 'none';
        document.getElementById('guest-loading').style.display = 'block';
    } else {
        // HOST: Mostra pannello Host
        document.getElementById('host-panel').style.display = 'block';
        document.getElementById('guest-loading').style.display = 'none';
    }

    // --- GESTIONE PEER ---
    const ICE_LAN = [];
    const ICE_WAN = [{ urls: 'stun:stun.l.google.com:19302' }];

    modeSwitch.addEventListener('change', () => { restartPeer(); updateShield(); });

    function updateShield() {
        shieldIcon.style.display = modeSwitch.checked ? 'inline' : 'none';
    }
    updateShield(); // Init icona

    function restartPeer() {
        if(peer) peer.destroy();
        init();
    }

    function init() {
        myId = Math.random().toString(36).substr(2, 5).toUpperCase();
        
        // Config: Se Bunker ON -> array vuoto, altrimenti STUN
        const config = { 
            iceServers: modeSwitch.checked ? ICE_LAN : ICE_WAN 
        };

        peer = new Peer(myId, { config: config, debug: 1 });

        peer.on('open', (id) => {
            myId = id;
            if (targetId) {
                // Sono l'ospite -> Mi connetto
                connectToHost(targetId);
            } else {
                // Sono l'host -> Genero QR
                generateQR(id);
            }
        });

        peer.on('connection', (c) => handleConnection(c));
        
        peer.on('error', (err) => {
            console.error(err);
            if(targetId) {
                alert("Errore connessione: " + err.type + "\nControlla di essere sulla stessa WiFi.");
            }
        });
    }

    function connectToHost(id) {
        const c = peer.connect(id, { reliable: true });
        c.on('open', () => handleConnection(c));
        // Fallback se lento
        setTimeout(() => {
            if(!conn || !conn.open) {
                if(targetId) alert("La connessione sta impiegando troppo tempo. Assicurati che il PC abbia la pagina aperta e siate sulla stessa WiFi.");
            }
        }, 10000);
    }

    function handleConnection(c) {
        conn = c;
        // Nascondi TUTTO tranne Transfer Area
        document.getElementById('host-panel').style.display = 'none';
        document.getElementById('guest-loading').style.display = 'none';
        document.getElementById('transfer-area').style.display = 'block';

        conn.on('data', d => handleData(d));
        conn.on('close', () => { alert("Disconnesso"); location.reload(); });
        conn.on('error', e => console.error(e));
    }

    // --- MOTORE DI INVIO (ANTI-CRASH) ---
    const CHUNK = 16 * 1024; // 16KB
    const MAX_BUF = 64 * 1024; 

    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !conn) return;

        document.getElementById('send-progress').style.display = 'block';
        conn.send({ type: 'HEAD', name: file.name, size: file.size });

        let offset = 0;
        while (offset < file.size) {
            // Backpressure: Pausa se buffer pieno
            if (conn.dataChannel.bufferedAmount > MAX_BUF) {
                await new Promise(r => setTimeout(r, 10));
                continue;
            }
            const chunk = file.slice(offset, offset + CHUNK);
            const buff = await chunk.arrayBuffer();
            conn.send(buff);
            offset += buff.byteLength;

            // UI Update
            if (offset % (CHUNK * 50) === 0 || offset >= file.size) {
                const pct = Math.round((offset/file.size)*100);
                document.getElementById('send-fill').style.width = pct + "%";
                document.getElementById('send-percent').textContent = pct + "%";
            }
        }
        conn.send({ type: 'DONE' });
        setTimeout(() => document.getElementById('send-progress').style.display = 'none', 2000);
    });

    // --- RICEZIONE ---
    let rxBuf = [], rxMeta = null, rxSize = 0;

    function handleData(data) {
        if (data.type === 'HEAD') {
            rxMeta = data; rxBuf = []; rxSize = 0;
            document.getElementById('rec-progress').style.display = 'block';
            document.getElementById('rec-name').textContent = data.name;
        } else if (data.type === 'DONE') {
            saveFile();
        } else {
            rxBuf.push(data);
            rxSize += data.byteLength;
            if (rxMeta && rxSize % (CHUNK * 50) === 0) {
                const pct = Math.round((rxSize/rxMeta.size)*100);
                document.getElementById('rec-fill').style.width = pct + "%";
                document.getElementById('rec-percent').textContent = pct + "%";
            }
        }
    }

    function saveFile() {
        const blob = new Blob(rxBuf);
        const url = URL.createObjectURL(blob);
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `
            <div><b>${rxMeta.name}</b><br><small>${formatBytes(rxMeta.size)}</small></div>
            <a href="${url}" download="${rxMeta.name}" class="btn-dl">SCARICA</a>
        `;
        document.getElementById('file-list').prepend(div);
        document.getElementById('empty-msg').style.display = 'none';
        document.getElementById('rec-progress').style.display = 'none';
        rxBuf = []; rxMeta = null;
    }

    // --- UI UTILS ---
    function generateQR(id) {
        const link = window.location.href.split('?')[0] + '?connectTo=' + id;
        const cvs = document.getElementById('qr-canvas');
        
        QRCode.toCanvas(cvs, link, { width: 220, margin: 1 }, () => {
            document.getElementById('qr-loading').style.display = 'none';
            cvs.style.display = 'inline-block';
            document.getElementById('link-text').textContent = link;
            document.getElementById('link-text').dataset.link = link;
        });
    }

    function copyLink() {
        const link = document.getElementById('link-text').dataset.link;
        if(link) navigator.clipboard.writeText(link).then(() => alert("Link copiato!"));
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + ['B', 'KB', 'MB', 'GB'][i];
    }

    init();
</script>
</body>
</html>
