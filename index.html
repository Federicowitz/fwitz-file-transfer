<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy LAN Share</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f4f9; }
        .btn { padding: 15px 30px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; margin: 10px; width: 80%; max-width: 300px; }
        .btn-send { background: #007bff; color: white; }
        .btn-rec { background: #28a745; color: white; }
        #qr-area { margin: 20px auto; display: none; }
        #status { font-weight: bold; margin: 15px; color: #555; }
        #reader { width: 100%; max-width: 400px; margin: auto; display: none; }
        .hidden { display: none; }
        #file-area { border: 2px dashed #ccc; padding: 20px; margin-top: 20px; display: none; background: white; }
    </style>
</head>
<body>

    <h2>âš¡ Easy Share (1 QR)</h2>
    <p id="status">Scegli il tuo ruolo</p>

    <div id="menu">
        <button class="btn btn-send" onclick="initSender()">Voglio INVIARE (Mostra QR)</button>
        <button class="btn btn-rec" onclick="initReceiver()">Voglio RICEVERE (Scansiona)</button>
    </div>

    <!-- QR AREA (Per chi invia) -->
    <div id="qr-area">
        <canvas id="qr-canvas"></canvas>
        <p>Fai scansionare questo QR al ricevente</p>
    </div>

    <!-- SCANNER AREA (Per chi riceve) -->
    <div id="reader"></div>

    <!-- FILE AREA (Appare dopo connessione) -->
    <div id="file-area">
        <h3>Trasferimento File</h3>
        <input type="file" id="fileInput">
        <div id="log" style="text-align:left; margin-top:10px;"></div>
    </div>

    <script>
        let peer;
        let conn;

        // Funzione per generare ID casuali brevi (La "Chiave")
        function generateId() {
            return Math.random().toString(36).substr(2, 5).toUpperCase();
        }

        // --- LATO MITTENTE (Chi mostra il QR) ---
        function initSender() {
            const myId = generateId();
            document.getElementById('status').textContent = "Connessione al Broker...";
            
            // Creiamo la nostra identitÃ  sul server pubblico PeerJS
            peer = new Peer(myId);

            peer.on('open', (id) => {
                document.getElementById('status').textContent = "In attesa di scansione...";
                document.getElementById('menu').style.display = 'none';
                document.getElementById('qr-area').style.display = 'block';
                
                // Genera QR con il nostro ID
                QRCode.toCanvas(document.getElementById('qr-canvas'), id, { width: 250 });
            });

            // Quando qualcuno si connette a noi
            peer.on('connection', (connection) => {
                conn = connection;
                setupConnection("Inviante");
            });
        }

        // --- LATO RICEVENTE (Chi scansiona) ---
        function initReceiver() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('reader').style.display = 'block';
            
            const html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10 }, (decodedText) => {
                // Trovato il QR (che contiene l'ID dell'altro)
                html5QrCode.stop();
                document.getElementById('reader').style.display = 'none';
                connectToPeer(decodedText);
            });
        }

        function connectToPeer(remoteId) {
            document.getElementById('status').textContent = "Connessione a " + remoteId + "...";
            peer = new Peer(); // ID automatico per me
            
            peer.on('open', () => {
                // Mi connetto all'ID letto dal QR
                conn = peer.connect(remoteId);
                conn.on('open', () => setupConnection("Ricevente"));
            });
        }

        // --- LOGICA COMUNE (Trasferimento) ---
        function setupConnection(role) {
            document.getElementById('qr-area').style.display = 'none';
            document.getElementById('status').textContent = "ðŸŸ¢ Connesso con " + conn.peer;
            document.getElementById('status').style.color = "green";
            document.getElementById('file-area').style.display = 'block';

            // Ricezione Dati
            conn.on('data', (data) => {
                if (data.file) {
                    // Ãˆ un file (blob)
                    const blob = new Blob([data.file]);
                    const url = URL.createObjectURL(blob);
                    const link = `<div style="background:#eee; padding:10px; margin:5px;">
                        <strong>${data.name}</strong> (${Math.round(data.size/1024)} KB)<br>
                        <a href="${url}" download="${data.name}" style="color:blue; font-weight:bold;">SCARICA</a>
                    </div>`;
                    document.getElementById('log').innerHTML += link;
                }
            });
        }

        // Invio File
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || !conn) return;

            document.getElementById('status').textContent = "Invio in corso...";
            
            // PeerJS gestisce automaticamente la serializzazione binaria
            conn.send({
                file: file,
                name: file.name,
                size: file.size
            });
            
            document.getElementById('log').innerHTML += `<div style="color:gray">Inviato: ${file.name}</div>`;
            document.getElementById('status').textContent = "ðŸŸ¢ Pronto";
        });
    </script>
</body>
</html>
