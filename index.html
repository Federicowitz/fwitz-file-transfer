<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UltraShare LAN</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/polyfill.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --text: #f8fafc;
            --success: #10b981; --danger: #ef4444; --border: #334155;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { padding: 15px; background: rgba(15,23,42,0.95); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .brand { font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        .tag-lan { font-size: 0.7rem; background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .status { font-size: 1.5rem; }

        footer {
            padding: 10px 20px;
            text-align: center;
            background: rgba(15,23,42,0.95);
            border-top: 1px solid var(--border);
            font-size: 0.9rem;
            color: #94a3b8;
        }


        /* MAIN */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; max-width: 600px; margin: 0 auto; width: 100%; }

        /* CARDS */
        .card { background: var(--card); border-radius: 16px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); }
        
        /* CONTROLS */
        .controls-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.9rem; color: #94a3b8; }
        select { background: var(--card); color: white; border: 1px solid var(--border); padding: 6px 10px; border-radius: 8px; outline: none; font-family: inherit; }

        /* UPLOAD ZONE (FIXED) */
        .upload-zone {
            display: flex; /* FIX: Ora Ã¨ un contenitore flex */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border); 
            border-radius: 16px; 
            padding: 40px 20px; 
            text-align: center;
            position: relative; 
            transition: 0.2s; 
            cursor: pointer; 
            background: rgba(255,255,255,0.02);
            width: 100%; /* Occupa tutto lo spazio */
        }
        .upload-zone:active { background: rgba(59, 130, 246, 0.1); border-color: var(--accent); }
        .upload-zone input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; z-index: 5; cursor: pointer; }

        /* ICONS */
        .folder-icon { font-size: 3rem; margin-bottom: 10px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); }

        /* FILE LIST */
        .file-item {
            background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 8px;
            border-left: 4px solid var(--border); animation: slideIn 0.3s;
        }
        .file-item.sending { border-left-color: var(--accent); }
        .file-item.receiving { border-left-color: var(--success); }
        
        .progress-track { height: 4px; background: #334155; margin-top: 8px; border-radius: 2px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; transition: width 0.1s linear; }
        .sending .progress-bar { background: var(--accent); }
        .receiving .progress-bar { background: var(--success); }

        /* UTILS */
        .hidden { display: none !important; }
        .btn-link { color: var(--accent); text-decoration: underline; cursor: pointer; margin-top: 10px; display: inline-block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div class="brand">
        âš¡ UltraShare <span class="tag-lan">LAN</span>
    </div>
    <div id="status-icon" class="status" title="Stato">ðŸ“¡</div>
</header>

<div class="main-content">

    <!-- SETUP AREA -->
    <div id="panel-setup" class="card">
        <div id="host-mode">
            <div style="text-align:center;">
                <canvas id="qr-canvas" style="display:none; margin: 0 auto; border: 5px solid white; border-radius: 8px;"></canvas>
                <div id="loading-txt" style="color:#94a3b8; margin: 20px 0;">Creating local network...</div>
                
                <div id="link-box" class="hidden">
                    <div style="margin-bottom:5px; color:#cbd5e1; font-size:0.9rem">Scan QR or share link</div>
                    <span class="btn-link" onclick="copyLink()">Copia Direct Link</span>
                </div>
            </div>
        </div>

        <div id="guest-mode" class="hidden" style="text-align:center; padding:20px;">
            <h3>ðŸ”— Connecting..</h3>
            <p style="color:#94a3b8">Don't leave this page unless you have finished</p>
        </div>
    </div>

    <!-- TRANSFER AREA -->
    <div id="panel-transfer" class="hidden">
        
        <div class="controls-row">
            <span>ðŸš€ Performance</span>
            <select id="chunk-selector">
                <option value="16384">16 KB (Stable)</option>
                <option value="262144">256 KB</option>
                <option value="524288" selected>512 KB (Default)</option>
                <option value="1048576">1 MB (Fast)</option>
            </select>
        </div>

        <div class="card">
            <label class="upload-zone">
                <div class="folder-icon">ðŸ“‚</div>
                <div style="font-weight:600; font-size:1.1rem">Touch here to send</div>
                <div style="font-size:0.8rem; color:#94a3b8; margin-top:5px">works with Multi-file</div>
                <input type="file" id="fileInput" multiple>
            </label>
        </div>

        <div id="file-list"></div>
    </div>

</div>



<template id="tpl-file">
    <div class="file-item">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:75%" class="t-name">File</div>
            <div style="font-size:0.8rem; font-family:monospace" class="t-pct">0%</div>
        </div>
        <div style="font-size:0.75rem; color:#94a3b8; margin-top:4px" class="t-meta">Waiting...</div>
        <div class="progress-track"><div class="progress-bar"></div></div>
    </div>
</template>

<footer> by Federicowitz </footer>

<script>
    // Configurazione LAN Only
    const PEER_CONFIG = { iceServers: [], debug: 0 };
    streamSaver.mitm = 'https://jimmywarting.github.io/StreamSaver.js/mitm.html?version=2.0.0';

    const state = { peer: null, conn: null, chunkSize: 524288 };

    const els = {
        status: document.getElementById('status-icon'),
        qr: document.getElementById('qr-canvas'),
        fileInput: document.getElementById('fileInput'),
        fileList: document.getElementById('file-list'),
        chunkSel: document.getElementById('chunk-selector')
    };

    // Cambio Chunk Size al volo
    els.chunkSel.addEventListener('change', (e) => state.chunkSize = parseInt(e.target.value));

    // INIT
    const urlParams = new URLSearchParams(window.location.search);
    const targetId = urlParams.get('connectTo');

    if (targetId) {
        document.getElementById('host-mode').classList.add('hidden');
        document.getElementById('guest-mode').classList.remove('hidden');
        initPeer(targetId);
    } else {
        initPeer(null);
    }

    function initPeer(connectTo) {
        const myId = Math.random().toString(36).substr(2, 5).toUpperCase();
        try { state.peer = new Peer(myId, { config: PEER_CONFIG }); } catch(e){}

        state.peer.on('open', (id) => {
            if (!connectTo) {
                // Host
                const url = window.location.href.split('?')[0] + '?connectTo=' + id;
                QRCode.toCanvas(els.qr, url, { width: 220, margin: 2, color: { dark: "#000", light: "#FFF" } }, () => {
                    els.qr.style.display = 'block';
                    document.getElementById('loading-txt').style.display = 'none';
                    const linkBox = document.getElementById('link-box');
                    linkBox.classList.remove('hidden');
                    linkBox.dataset.link = url;
                });
            } else {
                // Guest
                const c = state.peer.connect(connectTo, { reliable: true });
                setupConn(c);
            }
        });

        state.peer.on('connection', setupConn);
        state.peer.on('error', err => {
            console.log("Peer:", err.type);
            if(err.type === 'network' || err.type === 'disconnected') els.status.innerText = "âš ï¸";
        });
    }

    function setupConn(c) {
        state.conn = c;
        c.on('open', () => {
            document.getElementById('panel-setup').classList.add('hidden');
            document.getElementById('panel-transfer').classList.remove('hidden');
            els.status.innerText = "ðŸš€";
            if('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(()=>{});
        });
        c.on('data', handleData);
        c.on('close', () => { els.status.innerText = "âŒ"; alert("Disconnesso"); });
    }

    // --- SENDER ---
    els.fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if(!state.conn || !state.conn.open) return alert("Non connesso!");

        for (const file of files) {
            const ui = createLogUI(file.name, 'sending');
            const fileId = Math.random().toString(36).substr(2);
            const CHUNK = state.chunkSize;

            state.conn.send({ type: 'HEAD', id: fileId, name: file.name, size: file.size });

            let offset = 0;
            const startTime = Date.now();
            const BUFFER_MAX = 8 * 1024 * 1024; 
            const BUFFER_LOW = CHUNK * 2;

            try {
                while (offset < file.size) {
                    if (state.conn.dataChannel.bufferedAmount > BUFFER_MAX) {
                        ui.meta.innerText = "Attesa rete...";
                        while (state.conn.dataChannel.bufferedAmount > BUFFER_LOW) {
                            await new Promise(r => setTimeout(r, 10));
                        }
                    }

                    const chunk = await file.slice(offset, offset + CHUNK).arrayBuffer();
                    state.conn.send({ type: 'CHUNK', id: fileId, data: chunk });
                    offset += chunk.byteLength;

                    if (offset % (CHUNK * 5) === 0 || offset >= file.size) updateLogUI(ui, offset, file.size, startTime);
                }
                state.conn.send({ type: 'DONE', id: fileId });
                finalizeUI(ui, "Completato", true);
            } catch (err) { finalizeUI(ui, "Errore", false); }
        }
        els.fileInput.value = '';
    });

    // --- RECEIVER ---
    const streams = {};
    function handleData(d) {
        if (d.type === 'HEAD') {
            const ui = createLogUI(d.name, 'receiving');
            try {
                const ws = streamSaver.createWriteStream(d.name, { size: d.size });
                streams[d.id] = { writer: ws.getWriter(), received: 0, size: d.size, start: Date.now(), ui };
            } catch(e) { finalizeUI(ui, "Err Write", false); }
        } else if (d.type === 'CHUNK') {
            const s = streams[d.id];
            if(s) {
                s.writer.write(new Uint8Array(d.data));
                s.received += d.data.byteLength;
                if (Math.random() > 0.8 || s.received === s.size) updateLogUI(s.ui, s.received, s.size, s.start);
            }
        } else if (d.type === 'DONE') {
            const s = streams[d.id];
            if(s) { s.writer.close(); finalizeUI(s.ui, "Salvato", true); delete streams[d.id]; }
        }
    }

    function createLogUI(name, mode) {
        const tpl = document.getElementById('tpl-file').content.cloneNode(true);
        const el = tpl.querySelector('.file-item');
        el.classList.add(mode);
        tpl.querySelector('.t-name').innerText = name;
        els.fileList.prepend(el);
        return { 
            el, 
            meta: el.querySelector('.t-meta'), 
            bar: el.querySelector('.progress-bar'), 
            pct: el.querySelector('.t-pct') 
        };
    }

    function updateLogUI(ui, curr, total, start) {
        const p = ((curr / total) * 100).toFixed(0);
        ui.bar.style.width = p + "%";
        ui.pct.innerText = p + "%";
        const mbps = (curr/1024/1024 / ((Date.now() - start) / 1000)).toFixed(1);
        ui.meta.innerText = `${mbps} MB/s`;
    }

    function finalizeUI(ui, msg, ok) {
        ui.meta.innerText = msg;
        ui.pct.innerText = ok ? "âœ“" : "!";
        ui.bar.style.background = ok ? "var(--success)" : "var(--danger)";
    }

    function copyLink() {
        const link = document.getElementById('link-box').dataset.link;
        if(link) navigator.clipboard.writeText(link).then(() => alert("Copiato!"));
    }
</script>
</body>
</html>
