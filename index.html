<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UltraShare Stable</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/polyfill.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --text: #f8fafc;
            --success: #10b981; --danger: #ef4444; --border: #334155;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { padding: 15px; background: rgba(15,23,42,0.9); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .brand { font-weight: 800; font-size: 1.2rem; display: flex; gap: 10px; align-items: center; }
        .status { font-size: 1.5rem; }

        /* MAIN SCROLLABLE AREA */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; }

        /* CARDS */
        .card { background: var(--card); border-radius: 16px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        
        /* UPLOAD ZONE */
        .upload-zone {
            border: 2px dashed var(--border); border-radius: 12px; padding: 40px 20px; text-align: center;
            position: relative; transition: 0.3s; cursor: pointer; background: rgba(255,255,255,0.02);
        }
        .upload-zone:active { background: rgba(59, 130, 246, 0.1); border-color: var(--accent); }
        .upload-zone input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; z-index: 5; cursor: pointer; }

        /* FILE LIST */
        .file-item {
            background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 10px;
            border-left: 4px solid var(--border); animation: slideIn 0.3s;
        }
        .file-item.sending { border-left-color: var(--accent); }
        .file-item.receiving { border-left-color: var(--success); }
        
        .progress-track { height: 6px; background: #334155; margin-top: 10px; border-radius: 3px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; transition: width 0.2s linear; }
        .sending .progress-bar { background: var(--accent); }
        .receiving .progress-bar { background: var(--success); }

        .btn-trash { float: right; background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.5; }

        /* UTILS */
        .hidden { display: none !important; }
        .switch-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* TOGGLE */
        .switch { position: relative; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #475569; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(22px); }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <span>‚ö° UltraShare</span>
    </div>
    <div id="status-icon" class="status">üì°</div>
</header>

<div class="main-content">

    <!-- SETUP PANEL -->
    <div id="panel-setup" class="card">
        <div id="host-mode">
            <div class="switch-row">
                <div>
                    <strong>Modalit√† Bunker</strong>
                    <div style="font-size:0.8rem; color:#94a3b8">Solo WiFi Locale (Pi√π privacy)</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="modeSwitch">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div style="text-align:center; margin-top:20px;">
                <canvas id="qr-canvas" style="display:none; margin: 0 auto; border: 6px solid white; border-radius: 8px;"></canvas>
                <div id="loading-txt" style="color:#94a3b8">Inizializzazione...</div>
                <div id="link-box" class="hidden" style="margin-top:15px; color:var(--accent); text-decoration:underline; cursor:pointer;" onclick="copyLink()">
                    Copia Link Connessione
                </div>
            </div>
        </div>

        <div id="guest-mode" class="hidden" style="text-align:center; padding:20px;">
            <h3>üîó Connessione...</h3>
            <p style="color:#94a3b8">Non chiudere questa pagina.</p>
        </div>
    </div>

    <!-- TRANSFER PANEL -->
    <div id="panel-transfer" class="hidden">
        <div class="card">
            <label class="upload-zone">
                <div style="font-size:3rem; margin-bottom:10px">üìÇ</div>
                <div style="font-size:1.1rem; font-weight:600">Tocca per inviare</div>
                <div style="font-size:0.9rem; color:#94a3b8; margin-top:5px">Scrittura Diretta su Disco</div>
                <input type="file" id="fileInput" multiple>
            </label>
        </div>

        <div id="file-list"></div>
    </div>

</div>

<!-- TEMPLATES -->
<template id="tpl-file">
    <div class="file-item">
        <button class="btn-trash">üóëÔ∏è</button>
        <div style="font-weight:600; margin-bottom:5px" class="t-name">File.ext</div>
        <div style="font-size:0.8rem; color:#94a3b8" class="t-meta">Attesa...</div>
        <div class="progress-track"><div class="progress-bar"></div></div>
    </div>
</template>

<script>
    // --- SETTINGS ---
    const CHUNK_SIZE = 512 * 1024; // 512KB (Ridotto per stabilit√† su Android)
    const BUFFER_LIMIT = 8 * 1024 * 1024; // 8MB Max Buffer
    const BUFFER_DRAIN = 1 * 1024 * 1024; // 1MB Drain Target (Aspetta che si svuoti fino a qui)
    
    streamSaver.mitm = 'https://jimmywarting.github.io/StreamSaver.js/mitm.html?version=2.0.0';

    // --- STATE ---
    const state = {
        peer: null, conn: null, myId: null,
        isLan: localStorage.getItem('lanMode') !== 'false',
        wakeLock: null
    };

    const els = {
        status: document.getElementById('status-icon'),
        modeSwitch: document.getElementById('modeSwitch'),
        qr: document.getElementById('qr-canvas'),
        fileInput: document.getElementById('fileInput'),
        fileList: document.getElementById('file-list')
    };

    // --- WAKE LOCK ---
    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try { state.wakeLock = await navigator.wakeLock.request('screen'); } catch {}
        }
    }

    // --- INIT ---
    const urlParams = new URLSearchParams(window.location.search);
    const targetId = urlParams.get('connectTo');

    els.modeSwitch.checked = state.isLan;
    els.modeSwitch.addEventListener('change', (e) => {
        localStorage.setItem('lanMode', e.target.checked);
        location.reload();
    });

    if (targetId) {
        document.getElementById('host-mode').classList.add('hidden');
        document.getElementById('guest-mode').classList.remove('hidden');
        initPeer(targetId);
    } else {
        initPeer(null);
    }

    function initPeer(connectTo) {
        const config = { 
            iceServers: state.isLan ? [] : [{ urls: 'stun:stun.l.google.com:19302' }],
            debug: 0 
        };
        
        try {
            state.peer = new Peer(Math.random().toString(36).substr(2, 5).toUpperCase(), { config });
        } catch(e) { console.error(e); }

        state.peer.on('open', (id) => {
            if (!connectTo) {
                // Host Logic
                const url = window.location.href.split('?')[0] + '?connectTo=' + id;
                QRCode.toCanvas(els.qr, url, { width: 200, margin: 1 }, () => {
                    els.qr.style.display = 'block';
                    document.getElementById('loading-txt').style.display = 'none';
                    const linkBox = document.getElementById('link-box');
                    linkBox.classList.remove('hidden');
                    linkBox.dataset.link = url;
                });
            } else {
                // Guest Logic
                const c = state.peer.connect(connectTo, { reliable: true });
                setupConn(c);
            }
        });

        state.peer.on('connection', (c) => setupConn(c));
        
        // GESTIONE ERRORI INTELLIGENTE
        state.peer.on('error', err => {
            console.warn("Peer Warning:", err);
            // Mostra crash SOLO se √® un errore fatale
            if (err.type === 'peer-unavailable' || err.type === 'disconnected' || err.type === 'network') {
                els.status.innerText = "üí•";
                alert("Errore critico connessione: " + err.type);
            }
        });
    }

    function setupConn(c) {
        state.conn = c;
        
        c.on('open', () => {
            document.getElementById('panel-setup').classList.add('hidden');
            document.getElementById('panel-transfer').classList.remove('hidden');
            els.status.innerText = "üöÄ";
            requestWakeLock();
        });

        c.on('data', d => handleData(d));
        c.on('close', () => els.status.innerText = "üí•");
        // Non settiamo l'icona crash su 'error' generico della connessione
        c.on('error', e => console.error("Conn Error (Ignorato se non critico):", e));
    }

    // --- SENDER CORE (DEEP DRAIN LOGIC) ---
    els.fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if(!state.conn || !state.conn.open) return alert("Non connesso!");

        for (const file of files) {
            const ui = createLogUI(file.name, 'sending');
            const fileId = Math.random().toString(36).substr(2);

            state.conn.send({ type: 'HEAD', id: fileId, name: file.name, size: file.size });

            let offset = 0;
            const startTime = Date.now();

            try {
                while (offset < file.size) {
                    const buffered = state.conn.dataChannel.bufferedAmount;
                    
                    // --- LOGICA CHIAVE: DEEP DRAIN ---
                    // Se il buffer √® pieno, aspettiamo che si SVUOTI quasi del tutto
                    if (buffered > BUFFER_LIMIT) {
                        ui.meta.innerText = "Pausa Buffer (Network saturo)...";
                        while (state.conn.dataChannel.bufferedAmount > BUFFER_DRAIN) {
                            await new Promise(r => setTimeout(r, 50)); // Attesa attiva
                        }
                    }

                    // Lettura Chunk
                    const chunk = file.slice(offset, offset + CHUNK_SIZE);
                    const buffer = await chunk.arrayBuffer();
                    
                    state.conn.send({ type: 'CHUNK', id: fileId, data: buffer });
                    offset += buffer.byteLength;

                    // Update UI ogni tanto
                    if (offset % (CHUNK_SIZE * 5) === 0 || offset >= file.size) {
                        updateLogUI(ui, offset, file.size, startTime);
                    }
                }
                
                state.conn.send({ type: 'DONE', id: fileId });
                finalizeUI(ui, "Inviato", true);

            } catch (err) {
                console.error(err);
                finalizeUI(ui, "Errore Invio", false);
            }
        }
        els.fileInput.value = ''; 
    });

    // --- RECEIVER CORE ---
    const streams = {}; 

    function handleData(d) {
        if (d.type === 'HEAD') {
            const ui = createLogUI(d.name, 'receiving');
            try {
                const ws = streamSaver.createWriteStream(d.name, { size: d.size });
                streams[d.id] = { writer: ws.getWriter(), received: 0, size: d.size, start: Date.now(), ui };
            } catch(e) { finalizeUI(ui, "Err StreamSaver", false); }
        } 
        else if (d.type === 'CHUNK') {
            const s = streams[d.id];
            if(s) {
                s.writer.write(new Uint8Array(d.data));
                s.received += d.data.byteLength;
                
                // Aggiornamento UI throttled
                if(s.received % (CHUNK_SIZE * 5) === 0 || s.received === s.size) {
                    updateLogUI(s.ui, s.received, s.size, s.start);
                }
            }
        }
        else if (d.type === 'DONE') {
            const s = streams[d.id];
            if(s) {
                s.writer.close();
                finalizeUI(s.ui, "Salvato su Disco", true);
                delete streams[d.id];
            }
        }
    }

    // --- UI HELPERS ---
    function createLogUI(name, mode) {
        const tpl = document.getElementById('tpl-file').content.cloneNode(true);
        const el = tpl.querySelector('.file-item');
        const meta = tpl.querySelector('.t-meta');
        const bar = tpl.querySelector('.progress-bar');
        const trash = tpl.querySelector('.btn-trash');
        
        el.classList.add(mode);
        tpl.querySelector('.t-name').innerText = name;
        
        trash.onclick = () => el.remove();
        els.fileList.prepend(el);
        
        return { el, meta, bar };
    }

    function updateLogUI(ui, curr, total, start) {
        const pct = ((curr / total) * 100).toFixed(0);
        ui.bar.style.width = pct + "%";
        
        const sec = (Date.now() - start) / 1000;
        const speed = sec > 0 ? (curr/1024/1024 / sec).toFixed(1) : 0;
        ui.meta.innerText = `${pct}% ‚Ä¢ ${speed} MB/s`;
    }

    function finalizeUI(ui, msg, success) {
        ui.meta.innerText = msg;
        ui.bar.style.background = success ? "var(--success)" : "var(--danger)";
    }

    function copyLink() {
        const link = document.getElementById('link-box').dataset.link;
        if(link) navigator.clipboard.writeText(link).then(() => alert("Link copiato!"));
    }
</script>
</body>
</html>
