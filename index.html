<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federicowitz Share</title>
    <!-- Librerie essenziali (PeerJS per rete, QRCode per grafica) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    
    <style>
        /* --- STILI UI MODERNIZZATI --- */
        :root {
            --primary: #2563eb;       /* Blu moderno */
            --success: #10b981;       /* Verde smeraldo */
            --bg: #f3f4f6;            /* Grigio chiaro sfondo */
            --card: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 500px;
            margin: 20px auto;
            padding: 0 20px;
            flex: 1; /* Spinge il footer in basso */
        }

        h1 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* CARD */
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }

        /* TOGGLE SWITCH */
        .settings-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #eef2ff;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #e0e7ff;
        }
        .settings-label { font-size: 0.9rem; font-weight: 600; }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* QR AREA */
        #connection-panel { text-align: center; }
        #qr-canvas { border: 8px solid white; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin: 10px 0; max-width: 100%; }
        .link-box {
            background: #f8fafc;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--primary);
            word-break: break-all;
            cursor: pointer;
            border: 1px dashed #cbd5e1;
            margin-top: 10px;
        }
        .link-box:active { background: #e0f2fe; }

        /* UPLOAD BUTTON */
        .upload-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--primary);
            background: #eff6ff;
            color: var(--primary);
            padding: 30px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .upload-btn:hover { background: #dbeafe; transform: scale(1.01); }
        input[type="file"] { display: none; }

        /* PROGRESS BAR REALE */
        .progress-container { margin-top: 15px; display: none; }
        .progress-header { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; color: var(--text-muted); }
        .progress-track { width: 100%; background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s linear; }

        /* FILE LIST */
        .file-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--success);
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-name { font-weight: 500; font-size: 0.9rem; }
        .btn-download {
            background: var(--success); color: white;
            text-decoration: none; padding: 6px 12px;
            border-radius: 6px; font-size: 0.8rem; font-weight: 600;
        }

        /* STATUS BADGE */
        .status-badge {
            display: inline-block; padding: 4px 12px; border-radius: 20px;
            font-size: 0.8rem; font-weight: 700; background: #e5e7eb; color: var(--text-muted); margin-bottom: 15px;
        }
        .status-connected { background: #d1fae5; color: #065f46; }
        .status-error { background: #fee2e2; color: #991b1b; }

        /* FOOTER */
        footer {
            text-align: center;
            padding: 20px;
            font-size: 0.85rem;
            color: var(--text-muted);
            border-top: 1px solid #e5e7eb;
            background: white;
            margin-top: auto; /* Sticky bottom */
        }
        footer a { color: var(--text-muted); text-decoration: none; margin: 0 5px; }
        footer a:hover { color: var(--primary); text-decoration: underline; }

        /* UTILS */
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>
            <span id="shield-icon">üõ°Ô∏è</span> Federicowitz Share
        </h1>

        <!-- CARD 1: CONNESSIONE -->
        <div class="card" id="setup-card">
            
            <!-- SWITCHER MODALIT√Ä (Solo se sei Host) -->
            <div id="config-panel" class="settings-bar">
                <div>
                    <div class="settings-label">Modalit√† Bunker (LAN)</div>
                    <div style="font-size:0.75rem; color:#666">Solo rete locale, niente internet</div>
                </div>
                <label class="switch">
                    <!-- Default CHECKED per Bunker Mode -->
                    <input type="checkbox" id="modeSwitch" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <div id="connection-panel">
                <div id="status-badge" class="status-badge">Inizializzazione...</div>
                
                <div id="qr-container" class="hidden">
                    <canvas id="qr-canvas"></canvas>
                    <p style="font-size:0.85rem; color:#666; margin:5px 0;">Scansiona per connetterti</p>
                    
                    <!-- LINK TESTUALE COPIABILE -->
                    <div class="link-box" onclick="copyLink()" id="link-text">
                        Generazione link...
                    </div>
                </div>
            </div>
        </div>

        <!-- CARD 2: TRASFERIMENTO (Appare dopo connessione) -->
        <div id="transfer-area" class="hidden">
            
            <!-- SEZIONE INVIO -->
            <div class="card">
                <h3 style="margin-top:0; font-size:1rem; color:var(--text-muted)">üì§ INVIA FILE</h3>
                <label class="upload-btn">
                    <span style="font-size:2rem">üìÑ</span>
                    <span>Tocca per selezionare i file</span>
                    <input type="file" id="fileInput">
                </label>

                <!-- BARRA PROGRESSO INVIO -->
                <div id="send-progress" class="progress-container">
                    <div class="progress-header">
                        <span>Invio in corso...</span>
                        <span id="send-percent">0%</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="send-fill"></div>
                    </div>
                </div>
            </div>

            <!-- SEZIONE RICEZIONE -->
            <div class="card">
                <h3 style="margin-top:0; font-size:1rem; color:var(--text-muted)">üì• FILE RICEVUTI</h3>
                
                <!-- BARRA PROGRESSO RICEZIONE -->
                <div id="rec-progress" class="progress-container">
                    <div class="progress-header">
                        <span id="rec-filename">Ricezione...</span>
                        <span id="rec-percent">0%</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="rec-fill"></div>
                    </div>
                </div>

                <div id="file-list"></div>
                <div id="empty-msg" style="text-align:center; color:#9ca3af; font-size:0.9rem; padding:10px;">
                    In attesa di file...
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER CUSTOM -->
    <footer>
        <p>Made by <strong>Federicowitz</strong></p>
        <p>
            <a href="#">Il mio Sito</a> ‚Ä¢ 
            <a href="#">Instagram</a> ‚Ä¢ 
            <a href="#">Supporto</a>
        </p>
    </footer>

    <!-- LOGICA JAVASCRIPT -->
    <script>
        // --- STATO GLOBALE ---
        let peer;
        let conn;
        let myId = Math.random().toString(36).substr(2, 5).toUpperCase();
        
        // Elementi DOM
        const modeSwitch = document.getElementById('modeSwitch');
        const shieldIcon = document.getElementById('shield-icon');
        const statusBadge = document.getElementById('status-badge');
        
        // Parametri URL (se sei l'ospite che ha scansionato)
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('connectTo');

        // --- CONFIGURAZIONE RETE ---
        const ICE_BUNKER = []; // Vuoto = Solo LAN (Default)
        const ICE_PUBLIC = [{ urls: 'stun:stun.l.google.com:19302' }]; // Backup

        // --- INIZIALIZZAZIONE ---
        
        // Se c'√® un targetId, nascondiamo le impostazioni (sei l'ospite)
        if (targetId) {
            document.getElementById('config-panel').style.display = 'none';
        }

        // Listener per il cambio modalit√†
        modeSwitch.addEventListener('change', () => {
            restartPeer();
        });

        function restartPeer() {
            if(peer) peer.destroy();
            init();
        }

        function init() {
            updateUIState();

            // Configurazione in base allo switch
            // Se lo switch √® ON -> Bunker (Array Vuoto)
            // Se lo switch √® OFF -> Public (Google STUN)
            const config = { 
                iceServers: modeSwitch.checked ? ICE_BUNKER : ICE_PUBLIC 
            };

            peer = new Peer(myId, { config: config, debug: 1 });

            peer.on('open', (id) => {
                myId = id; // PeerJS conferma l'ID
                
                if (targetId) {
                    setStatus("Connessione all'Host...", "waiting");
                    connectToHost(targetId);
                } else {
                    setStatus("Pronto. Scansiona:", "ready");
                    generateQR(id);
                }
            });

            peer.on('connection', (c) => handleConnection(c));

            peer.on('error', (err) => {
                console.error(err);
                setStatus("Errore: " + err.type, "error");
                if (modeSwitch.checked && err.type === 'peer-unavailable') {
                    alert("Errore Bunker Mode: I dispositivi non sembrano essere sulla stessa WiFi.");
                }
            });
        }

        function updateUIState() {
            // Aggiorna icone in base alla modalit√†
            if (modeSwitch.checked) {
                shieldIcon.style.display = 'inline';
                shieldIcon.title = "Modalit√† Bunker Attiva";
            } else {
                shieldIcon.style.display = 'none';
            }
        }

        function connectToHost(id) {
            const c = peer.connect(id, { reliable: true });
            c.on('open', () => handleConnection(c));
            // Timeout di sicurezza
            setTimeout(() => {
                if(!conn || !conn.open) setStatus("Connessione lenta... riprova.", "error");
            }, 8000);
        }

        function handleConnection(c) {
            conn = c;
            setStatus("üü¢ Connesso!", "connected");
            
            // Nascondi QR e Config, Mostra Trasferimento
            document.getElementById('config-panel').style.display = 'none';
            document.getElementById('qr-container').style.display = 'none';
            document.getElementById('transfer-area').classList.remove('hidden');

            conn.on('data', (data) => handleIncomingData(data));
            conn.on('close', () => { alert("Disconnesso"); location.reload(); });
            conn.on('error', (err) => console.error("Conn Error", err));
        }

        // --- MOTORE DI INVIO FILE (Backpressure / Anti-Crash) ---
        const CHUNK_SIZE = 16 * 1024; // 16KB per pacchetto
        const MAX_BUFFER = 64 * 1024; // Max 64KB in buffer browser

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || !conn) return;

            // UI Reset
            document.getElementById('send-progress').style.display = 'block';
            updateProgress('send', 0);

            // 1. Manda Header
            conn.send({ type: 'HEAD', name: file.name, size: file.size });

            let offset = 0;

            // 2. Loop di invio con controllo buffer
            while (offset < file.size) {
                // Se il buffer √® pieno, PAUSA finch√© non si svuota
                if (conn.dataChannel.bufferedAmount > MAX_BUFFER) {
                    await new Promise(r => setTimeout(r, 10)); // Aspetta 10ms
                    continue; // Riprova
                }

                // Leggi e invia chunk
                const chunk = file.slice(offset, offset + CHUNK_SIZE);
                const buffer = await chunk.arrayBuffer();
                conn.send(buffer);

                offset += buffer.byteLength;

                // Aggiorna UI ogni tanto
                if (offset % (CHUNK_SIZE * 50) === 0 || offset >= file.size) {
                    const pct = Math.round((offset / file.size) * 100);
                    updateProgress('send', pct);
                }
            }

            // 3. Manda Fine
            conn.send({ type: 'DONE' });
            setTimeout(() => document.getElementById('send-progress').style.display = 'none', 2000);
        });

        // --- MOTORE RICEZIONE FILE ---
        let rxBuffer = [], rxMeta = null, rxSize = 0;

        function handleIncomingData(data) {
            if (data.type === 'HEAD') {
                rxMeta = data; rxBuffer = []; rxSize = 0;
                document.getElementById('rec-progress').style.display = 'block';
                document.getElementById('rec-filename').textContent = "Ricezione: " + data.name;
            } 
            else if (data.type === 'DONE') {
                saveFile();
            } 
            else {
                // √à un ArrayBuffer (Chunk dati)
                rxBuffer.push(data);
                rxSize += data.byteLength;
                
                // Aggiorna UI
                if (rxMeta && rxSize % (CHUNK_SIZE * 50) === 0) {
                    const pct = Math.round((rxSize / rxMeta.size) * 100);
                    updateProgress('rec', pct);
                }
            }
        }

        function saveFile() {
            const blob = new Blob(rxBuffer);
            const url = URL.createObjectURL(blob);
            
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `
                <div class="file-name">${rxMeta.name} <br> <small style="color:#aaa">${formatBytes(rxMeta.size)}</small></div>
                <a href="${url}" download="${rxMeta.name}" class="btn-download">SCARICA</a>
            `;
            
            document.getElementById('file-list').prepend(div);
            document.getElementById('empty-msg').style.display = 'none';
            document.getElementById('rec-progress').style.display = 'none';
            
            rxBuffer = []; rxMeta = null;
        }

        // --- FUNZIONI GRAFICHE & UTILIT√Ä ---
        
        function setStatus(msg, type) {
            const el = document.getElementById('status-badge');
            el.textContent = msg;
            el.className = 'status-badge'; // Reset
            if (type === 'connected') el.classList.add('status-connected');
            if (type === 'error') el.classList.add('status-error');
        }

        function updateProgress(type, pct) {
            document.getElementById(`${type}-fill`).style.width = pct + '%';
            document.getElementById(`${type}-percent`).textContent = pct + '%';
        }

        function generateQR(id) {
            // Ottieni URL base pulito (senza parametri vecchi)
            const baseUrl = window.location.href.split('?')[0];
            const fullLink = `${baseUrl}?connectTo=${id}`;
            
            // Genera QR
            const canvas = document.getElementById('qr-canvas');
            QRCode.toCanvas(canvas, fullLink, { width: 220, margin: 1, color: { dark: "#1f2937" } }, (err) => {
                if(!err) document.getElementById('qr-container').classList.remove('hidden');
            });

            // Mostra Link Testuale
            const linkBox = document.getElementById('link-text');
            linkBox.textContent = fullLink;
            linkBox.dataset.link = fullLink; // Salva per copia
        }

        function copyLink() {
            const link = document.getElementById('link-text').dataset.link;
            navigator.clipboard.writeText(link).then(() => {
                const original = document.getElementById('link-text').textContent;
                document.getElementById('link-text').textContent = "Copiato negli appunti! ‚úÖ";
                setTimeout(() => document.getElementById('link-text').textContent = original, 2000);
            });
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + ['B', 'KB', 'MB', 'GB'][i];
        }

        // Avvio app
        init();

    </script>
</body>
</html>
